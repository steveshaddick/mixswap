var Song = Backbone.Model.extend({
    defaults: {
        artist: "Unknown",
        title: "Untitled",
        isUserFav: false,
        totalFav: 0,
        prefix: ""
    },
    initialize: function() {
        this.urlRoot = "/mix/" + this.attributes.mixId + "/song/";
    }
});

var Songs = Backbone.Collection.extend({
    model: Song
});

var Mix = Backbone.Model.extend({
    urlRoot: "/mix",
    url: function() {
        var a = Backbone.Model.prototype.url.call(this);
        return a + (a.charAt(a.length - 1) == "/" ? "" : "/");
    },
    defaults: {
        title: "Mix Title",
        username: "Dude",
        isUserMix: false,
        pictureFiel: "",
        songs: [],
        comments: []
    },
    initialize: function() {
        this.songs = new Songs(this.attributes.songs);
    }
});

var MixView = Backbone.View.extend({
    initialize: function() {
        this.listenTo(this.model, "change:title", this.render);
        this.songs = new SongCollectionView({
            collection: this.model.songs,
            el: $(".song-list", this.el)[0]
        });
        this.songs.collection.trigger("reset");
    },
    render: function() {
        $("#mixTitle").html(this.model.attributes.title);
        $("#mixUsername").html("by " + this.model.attributes.username);
        return this;
    }
});

var SongCollectionView = Backbone.View.extend({
    initialize: function() {
        var a = this;
        this.listenTo(this.collection, "reset", this.renderReset);
        this.songViews = [];
        this.collection.each(function(b) {
            a.songViews.push(new SongView({
                model: b,
                tagName: "li",
                id: "song_" + b.attributes.id,
                className: "title"
            }));
        });
    },
    renderReset: function() {
        var a = this;
        _(this.songViews).each(function(b) {
            a.$el.append(b.render().$el);
        });
        return this;
    }
});

var SongView = Backbone.View.extend({
    initialize: function() {
        this.listenTo(this.model, "change:title", this.renderTitle);
    },
    render: function() {
        console.log("render songview");
        this.$el.html(this.model.attributes.title);
        return this;
    },
    renderTitle: function() {
        console.log("render title");
        this.$el.html(this.model.attributes.title);
    }
});

var CommentView = Backbone.View.extend({
    render: function() {}
});

var GLOBAL = {
    csrfToken: ""
};

function csrfSafeMethod(a) {
    return /^(GET|HEAD|OPTIONS|TRACE)$/.test(a);
}

var App = {
    init: function(a) {
        GLOBAL.csrfToken = Cookie.get("csrftoken");
        $.ajaxSetup({
            crossDomain: false,
            beforeSend: function(a, b) {
                if (!csrfSafeMethod(b.type)) {
                    a.setRequestHeader("X-CSRFToken", GLOBAL.csrfToken);
                }
            }
        });
        var b = Backbone.sync;
        Backbone.sync = function(a, c, d) {
            d.beforeSend = function(a) {
                a.setRequestHeader("X-CSRFToken", GLOBAL.csrfToken);
            };
            return b(a, c, d);
        };
        Backbone.emulateHTTP = true;
        this.mixView = new MixView({
            model: new Mix(a),
            el: $("#mix")[0]
        }).render();
        this.mixView.songs.collection.get(1).set({
            title: "New Title"
        });
        $("#picUploader").pluploadQueue({
            runtimes: "html5,flash,silverlight",
            url: $("#uploadPictureForm").attr("action"),
            file_data_name: "picfile",
            max_file_size: "10mb",
            unique_names: true,
            headers: {
                "X-CSRFToken": GLOBAL.csrfToken
            },
            resize: {
                width: 2e3,
                height: 2e3,
                quality: 70
            },
            rename: true,
            filters: [ {
                title: "Image files",
                extensions: "jpg,gif,png"
            } ],
            flash_swf_url: "/static/js/plupload/plupload.flash.swf",
            silverlight_xap_url: "/static/js/plupload/plupload.silverlight.xap"
        });
        $("#uploadPictureForm").submit(function(a) {
            var b = $("#picUploader").pluploadQueue();
            if (b.files.length > 0) {
                b.bind("StateChanged", function() {
                    if (b.files.length === b.total.uploaded + b.total.failed) {
                        $("#uploadPictureForm")[0].submit();
                    }
                });
                b.start();
            } else {
                alert("You must queue at least one file.");
            }
            return false;
        });
    }
};