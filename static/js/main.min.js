var GLOBAL = {
    csrfToken: ""
};

var Main = function() {
    function a(a) {
        return /^(GET|HEAD|OPTIONS|TRACE)$/.test(a);
    }
    function b() {
        GLOBAL.csrfToken = Cookie.get("csrftoken");
        $.ajaxSetup({
            crossDomain: false,
            beforeSend: function(b, c) {
                if (!a(c.type)) {
                    b.setRequestHeader("X-CSRFToken", GLOBAL.csrfToken);
                }
            }
        });
        $("#uploadPictureForm").fileupload({
            acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
            maxFileSize: 5e6,
            disableImageResize: false,
            imageMaxHeight: 300
        }).bind("fileuploadprogress", function(a, b) {
            console.log("progress", b);
        }).bind("fileuploadprogressall", function(a, b) {
            console.log("all", b);
        });
    }
    return {
        init: b
    };
}();

var mix;

function Mix(_mixId, _isMyMix, _isPublished, _bgImage) {
    var me = this;
    var mixTitle;
    var audioPlayer;
    var comments;
    var currentTrack;
    var currentSong;
    var songs = Array();
    var dragSource = false;
    var dragTarget = false;
    var isMyMix = _isMyMix;
    var isPublished = _isPublished;
    var filetype = "mp3";
    var mixFolder = "<?=$mixFolder?>";
    var isEditable;
    var modal;
    this.mixId = _mixId;
    this.elements = Array();
    function changeTitle() {
        var a;
        var b = prompt("Enter new title", me.elements["mixTitle"].innerHTML);
        if (b != null && b != "") {
            a = new AJAX("<?=PHP_CHANGE_TITLE?>", {
                mixId: me.mixId,
                newTitle: b
            });
            a.send();
            me.elements["mixTitle"].innerHTML = b;
        }
    }
    function togglePublish() {
        var a;
        isPublished = !isPublished;
        var b = "false";
        if (isPublished) {
            b = prompt("Do you want to send an email to everyone?  Enter 'y' if yes.");
            b = b.toLowerCase();
            b = b == "y" ? "true" : "false";
        }
        a = new AJAX("<?=PHP_PUBLISH_MIX?>", {
            mixId: me.mixId,
            isPublished: isPublished ? 1 : 0,
            isEmail: b
        });
        a.send();
        if (isPublished) {
            me.elements["publishSection"].className = "published";
            me.elements["publishMix"].innerHTML = "Unpublish";
        } else {
            me.elements["publishSection"].className = "unpublished";
            me.elements["publishMix"].innerHTML = "Publish";
        }
        setEditable();
    }
    function setEditable() {
        isEditable = isMyMix && !isPublished;
        if (isEditable) {
            me.elements["mixTitle"].onclick = changeTitle;
            me.elements["addTrack"].style.display = "block";
            me.elements["changeBG"].style.display = "block";
            me.elements["commentsSection"].style.display = "none";
            document.getElementById("btnUploadSong").onclick = uploadSong;
            for (var a = 0, b = songs.length; a < b; a++) {
                songs[a].setEditable(true);
                songs[a].element.addEventListener("dragstart", dragStart, false);
                songs[a].element.addEventListener("dragenter", dragEnter, false);
                songs[a].element.addEventListener("dragover", dragOver, false);
                songs[a].element.addEventListener("dragleave", dragLeave, false);
                songs[a].element.addEventListener("drop", dragDrop, false);
                songs[a].elements["deleteLink"].onclick = deleteSong;
                songs[a].elements["editLink"].onclick = editSong;
            }
        } else {
            me.elements["mixTitle"].onclick = null;
            me.elements["addTrack"].style.display = "none";
            me.elements["changeBG"].style.display = "none";
            me.elements["commentsSection"].style.display = "block";
            document.getElementById("btnUploadSong").onclick = null;
            for (var a = 0, b = songs.length; a < b; a++) {
                songs[a].setEditable(false);
                songs[a].element.removeEventListener("dragstart", dragStart, false);
                songs[a].element.removeEventListener("dragenter", dragEnter, false);
                songs[a].element.removeEventListener("dragover", dragOver, false);
                songs[a].element.removeEventListener("dragleave", dragLeave, false);
                songs[a].element.removeEventListener("drop", dragDrop, false);
                songs[a].elements["deleteLink"].onclick = null;
                songs[a].elements["editLink"].onclick = null;
            }
        }
    }
    function listSongs() {
        var a = false;
        var b = me.elements["songList"];
        for (var c = 0, d = songs.length; c < d; c++) {
            if (typeof b.childNodes[c] != "undefined") {
                if (b.childNodes[c] != songs[c].element) {
                    b.replaceChild(songs[c].element, b.childNodes[c]);
                }
            } else {
                b.appendChild(songs[c].element);
            }
            songs[c].setIndex(c);
        }
        while (b.childNodes.length > songs.length) {
            b.removeChild(b.lastChild);
        }
    }
    function deleteSong() {
        var a = songs[parseInt(this.parentNode.parentNode.getAttribute("data-index"))];
        if (confirm("Delete " + a.title + " by " + a.artist + "?")) {
            var b = new AJAX("<?=PHP_DELETE_SONG?>", {
                mixId: me.mixId,
                songId: a.songId,
                songIndex: a.index
            }, deleteSongHandler);
            b.send();
        }
    }
    function editSong() {
        var a = songs[parseInt(this.parentNode.parentNode.getAttribute("data-index"))];
        var b = a.title;
        var c = a.artist;
        var d = prompt("Enter new title", a.title);
        if (d == null) {
            return;
        }
        if (d == b) {
            d = "";
        }
        var e = prompt("Enter new artist", a.artist);
        if (e == null) {
            return;
        }
        if (e == c) {
            e = "";
        }
        if (d != "" || e != "") {
            var f = new AJAX("<?=PHP_EDIT_SONG?>", {
                mixId: me.mixId,
                songId: a.songId,
                title: d,
                artist: e
            });
            f.send();
        }
        if (d != "") {
            this.parentNode.parentNode.getElementsByClassName("songTitle")[0].innerHTML = d;
        }
        if (e != "") {
            this.parentNode.parentNode.getElementsByClassName("songArtist")[0].innerHTML = e;
        }
    }
    function editSongHandler(a) {
        console.log(a);
    }
    function deleteSongHandler(req) {
        var obj = eval("(" + req.responseText + ")");
        var songIndex = parseInt(obj.songIndex);
        removeSong(songIndex);
    }
    function removeSong(a) {
        songs.splice(a, 1);
        listSongs();
    }
    function playSong(a) {
        if (typeof currentSong != "undefined") {
            currentSong.setPlaying(false);
        }
        currentTrack = a.index;
        audioPlayer.playSong(a);
        currentSong = a;
        a.setPlaying(true);
    }
    function playHandler() {
        currentSong = songs[currentTrack];
        currentSong.setPlaying(true);
    }
    function pauseHandler() {
        currentSong.setPlaying(false);
    }
    function playNextTrack() {
        currentTrack = currentTrack < songs.length - 1 ? currentTrack + 1 : 0;
        if (currentTrack > 0) {
            playSong(songs[currentTrack]);
        }
    }
    function uploadSong() {
        modal = new Modal("Uploading song...");
        document.getElementById("frmUploadSong").submit();
    }
    function uploadBG() {
        modal = new Modal("Uploading image...");
        document.getElementById("frmUploadBG").submit();
    }
    function setBG(a) {}
    function dragStart(a) {
        a.stopPropagation();
        dragSource = this;
        dragSource.addEventListener("dragend", dragEnd, false);
        g.addClassName(dragSource, "dragged");
        a.dataTransfer.effectAllowed = "move";
        a.dataTransfer.setDragImage(dragSource, 0, 0);
        return true;
    }
    function dragEnter(a) {
        if (dragTarget) {
            g.removeClassName(dragTarget, "dragOver");
            dragTarget = false;
        }
        if (dragSource != this) {
            dragTarget = this;
            g.addClassName(dragTarget, "dragOver");
            a.dataTransfer.dropEffect = "move";
        }
        return false;
    }
    function dragOver(a) {
        a.stopPropagation();
        a.preventDefault();
        return false;
    }
    function dragLeave(a) {
        if (dragTarget && dragTarget != this) {
            g.removeClassName(dragTarget, "dragOver");
        }
    }
    function dragEnd(a) {
        if (dragTarget) {
            g.removeClassName(dragTarget, "dragOver");
            dragTarget = false;
        }
        if (dragSource) {
            g.removeClassName(dragSource, "dragged");
            dragSource.removeEventListener("dragend", dragEnd, false);
            dragSource = false;
        }
    }
    function dragDrop(a) {
        console.log(dragTarget, "DROP");
        a.stopPropagation();
        g.removeClassName(dragSource, "dragged");
        if (dragTarget) {
            g.removeClassName(dragTarget, "dragOver");
            if (dragSource != a.target) {
                var b = parseInt(dragSource.getAttribute("data-index"));
                var c = parseInt(dragTarget.getAttribute("data-index"));
                if (c > b) {
                    songs.splice(c + 1, 0, songs[b]);
                    songs.splice(b, 1);
                } else {
                    songs.splice(c, 0, songs[b]);
                    songs.splice(b + 1, 1);
                }
                listSongs();
            }
        }
        return false;
    }
    this.addSong = function(a, b, c, d, e, f) {
        if (b == "") {
            b = "[unartisted]";
        }
        if (c == "") {
            c = "[untitled]";
        }
        var g = new SongItem(a, songs.length, b, c, d, e, f, isEditable);
        songs.push(g);
        this.elements["songList"].appendChild(g.element);
        if (isEditable) {
            g.element.addEventListener("dragstart", dragStart, false);
            g.element.addEventListener("dragenter", dragEnter, false);
            g.element.addEventListener("dragover", dragOver, false);
            g.element.addEventListener("dragleave", dragLeave, false);
            g.element.addEventListener("drop", dragDrop, false);
        }
        g.elements["songLink"].onclick = function(a) {
            playSong(g);
        };
        if (isEditable) {
            g.elements["deleteLink"].onclick = deleteSong;
            g.elements["editLink"].onclick = editSong;
        }
        listSongs();
    };
    this.addComment = function(a, b, c) {
        comments.addComment(new CommentItem(a, b, c));
    };
    this.uploadSongDone = function(a, b, c, d) {
        this.addSong(a, b, c, d, false, 0);
        document.getElementById("frmUploadSong").reset();
        modal.closeModal();
    };
    this.uploadBGDone = function(a) {
        setBG(a);
        document.getElementById("frmUploadBG").reset();
        modal.closeModal();
    };
    this.elements["mixTitle"] = document.getElementById("mixTitle");
    this.elements["songList"] = document.getElementById("songList");
    this.elements["commentsSection"] = document.getElementById("scnComments");
    currentTrack = 0;
    audioPlayer = new AudioPlayer();
    audioPlayer.elements["audioElement"].addEventListener("ended", playNextTrack, false);
    audioPlayer.elements["audioElement"].addEventListener("play", playHandler, false);
    audioPlayer.elements["audioElement"].addEventListener("pause", pauseHandler, false);
    if (!isMyMix) {
        g.removeElementById("scnPublishMix");
        g.removeElementById("scnAddTrack");
        g.removeElementById("scnChangeBG");
    } else {
        this.elements["publishMix"] = document.getElementById("aPublishMix");
        this.elements["publishSection"] = document.getElementById("scnPublishMix");
        this.elements["addTrack"] = document.getElementById("scnAddTrack");
        this.elements["changeBG"] = document.getElementById("scnChangeBG");
        this.elements["publishMix"].onclick = togglePublish;
        document.getElementById("scnPublishMix").style.display = "block";
        if (isPublished) {
            me.elements["publishSection"].className = "published";
            this.elements["publishMix"].innerHTML = "Unpublish";
        } else {
            me.elements["publishSection"].className = "unpublished";
            this.elements["publishMix"].innerHTML = "Publish";
        }
        setEditable();
    }
    comments = new Comments();
    setBG(_bgImage);
}

function AudioPlayer() {
    var a = "<?=$songsFolder?>";
    this.element = document.getElementById("scnAudioPlayer");
    this.elements = Array();
    this.elements["audioElement"] = document.getElementById("audioElement");
    this.elements["currentTitle"] = document.getElementById("currentTitle");
    this.elements["currentArtist"] = document.getElementById("currentArtist");
    this.playSong = function(b) {
        this.elements["currentTitle"].innerHTML = b.title;
        this.elements["currentArtist"].innerHTML = b.artist;
        this.elements["audioElement"].src = a + b.file;
        this.elements["audioElement"].setAttribute("autoplay", "autoplay");
        this.elements["audioElement"].load();
    };
}

function SongItem(_songId, _index, _artist, _title, _file, _isMyFavourite, _favCount, _isEditable) {
    var me = this;
    var favCount = _favCount;
    this.songId = _songId;
    this.element = document.getElementById("refSongItem").cloneNode(true);
    this.elements = Array();
    this.elements["hitDrag"] = this.element.getElementsByClassName("hitDrag")[0];
    this.elements["chkFav"] = this.element.getElementsByClassName("chkFavourite")[0];
    this.elements["divFav"] = this.element.getElementsByClassName("divFavourite")[0];
    this.elements["songLink"] = this.element.getElementsByClassName("songLink")[0];
    this.elements["divDrag"] = this.element.getElementsByClassName("divDrag")[0];
    this.elements["deleteLink"] = this.element.getElementsByClassName("songDeleteLink")[0];
    this.elements["editLink"] = this.element.getElementsByClassName("songEditLink")[0];
    this.elements["song"] = this.element.getElementsByClassName("divSong")[0];
    this.elements["trackNumber"] = this.element.getElementsByClassName("songTrack")[0];
    this.elements["artist"] = this.element.getElementsByClassName("songArtist")[0];
    this.elements["title"] = this.element.getElementsByClassName("songTitle")[0];
    this.elements["favCount"] = this.element.getElementsByClassName("favCount")[0];
    this.artist = _artist;
    this.title = _title;
    this.index = _index;
    this.file = _file;
    function chkFavHandler() {
        var a = me.elements["chkFav"].checked ? 1 : 0;
        var b = new AJAX("<?=PHP_FAV_SONG?>", {
            mixId: mix.mixId,
            songId: me.songId,
            isFavourite: a
        }, favSongHandler);
        b.send();
    }
    function favSongHandler(req) {
        var obj = eval("(" + req.responseText + ")");
        favCount = parseInt(obj.favCount);
        setFavCount();
    }
    function setFavCount() {
        me.elements["favCount"].innerHTML = favCount + " favs";
    }
    this.setIndex = function(a) {
        var b = this.index;
        if (b != a) {
            this.index = a;
            this.element.setAttribute("id", "songItem_" + a);
            this.element.setAttribute("data-index", this.index);
            this.elements["trackNumber"].innerHTML = a + 1;
            var c = new AJAX("<?=PHP_SONG_INDEX?>", {
                songOrder: this.index,
                songId: this.songId
            });
            c.send();
        }
    };
    this.setEditable = function(a) {
        if (a) {
            this.elements["hitDrag"].style.display = "inline";
            this.elements["deleteLink"].style.display = "inline";
            this.elements["editLink"].style.display = "inline";
            this.elements["divFav"].style.display = "none";
            this.elements["divDrag"].style.display = "inline-block";
            this.element.setAttribute("draggable", "true");
        } else {
            this.elements["hitDrag"].style.display = "none";
            this.elements["deleteLink"].style.display = "none";
            this.elements["editLink"].style.display = "none";
            this.elements["divFav"].style.display = "inline";
            this.element.setAttribute("draggable", "false");
            this.elements["divDrag"].style.display = "none";
        }
    };
    this.setPlaying = function(a) {
        if (a) {
            g.addClassName(this.elements["song"], "songPlaying");
        } else {
            g.removeClassName(this.elements["song"], "songPlaying");
        }
    };
    this.element.setAttribute("id", "songItem_" + this.index);
    this.element.setAttribute("data-index", this.index);
    this.elements["chkFav"].onclick = chkFavHandler;
    if (_isMyFavourite) {
        this.elements["chkFav"].checked = true;
    }
    this.setEditable(_isEditable);
    this.elements["trackNumber"].innerHTML = this.index + 1;
    this.elements["artist"].innerHTML = this.artist;
    this.elements["title"].innerHTML = this.title;
    setFavCount();
}

function Comments() {
    var a = this;
    this.element = document.getElementById("scnComments");
    this.elements = Array();
    this.elements["commentsList"] = document.getElementById("divCommentsList");
    this.elements["txtAddComment"] = document.getElementById("txtAddComment");
    this.elements["btnAddComment"] = document.getElementById("btnAddComment");
    function b() {
        for (var a = 0, b = coments.length; a < b; a++) {}
    }
    function c() {
        var b = new AJAX("<?=PHP_ADD_COMMENT?>", {
            mixId: mix.mixId,
            comment: escape(a.elements["txtAddComment"].value)
        }, d);
        b.send();
    }
    function d(b) {
        var c = new Date();
        a.addComment(new CommentItem("<?=$displayName?>", c.toDateString(), a.elements["txtAddComment"].value));
        a.elements["txtAddComment"].value = "";
    }
    this.addComment = function(a) {
        this.elements["commentsList"].insertBefore(a.element, this.elements["commentsList"].firstChild);
    };
    this.elements["btnAddComment"].onclick = c;
}

function CommentItem(a, b, c) {
    var d = this;
    var e = new Date(b);
    this.element = document.getElementById("refCommentItem").cloneNode(true);
    this.element.removeAttribute("id");
    this.elements = Array();
    this.elements["userName"] = this.element.getElementsByClassName("commentUserName")[0];
    this.elements["time"] = this.element.getElementsByClassName("commentTime")[0];
    this.elements["text"] = this.element.getElementsByClassName("commentText")[0];
    this.elements["userName"].innerHTML = a;
    this.elements["time"].setAttribute("datetime", e.toString());
    this.elements["time"].innerHTML = e.toDateString();
    this.elements["text"].innerHTML = c;
}

function handleOrientationChange() {
    switch (window.orientation) {
      case 0:
        break;

      case -90:
        break;

      case 90:
        break;

      case 180:
        break;
    }
}