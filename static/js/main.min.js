function csrfSafeMethod(a){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(a)}var SongModel=Backbone.Model.extend({url:function(){var a=Backbone.Model.prototype.url.call(this);return a+("/"==a.charAt(a.length-1)?"":"/")},defaults:{artist:"Unknown",title:"Untitled",songFile:"",isUserFav:!1,totalFav:0,songOrder:1},onSync:function(a,b){this.set("totalFav",b.total_fav)},initialize:function(){this.urlRoot="/mix/"+this.attributes.mixId+"/song/",this.listenTo(this,"sync",this.onSync)}}),SongsCollection=Backbone.Collection.extend({model:SongModel,url:"",comparator:function(a){return a.get("songOrder")},updateSongOrder:function(){Backbone.sync("update",this,{})}}),MixModel=Backbone.Model.extend({urlRoot:"/mix",url:function(){var a=Backbone.Model.prototype.url.call(this);return a+("/"==a.charAt(a.length-1)?"":"/")},defaults:{title:"Mix Title",username:"Dude",isUserMix:!1,pictureFile:"",songs:[],comments:[]},initialize:function(){this.songs=new SongsCollection(this.attributes.songs),this.songs.url=this.url()+"update_song_order/",this.comments=new CommentsCollection,this.comments.url=this.url()+"comments/",this.comments.fetch()}}),CommentModel=Backbone.Model.extend({url:function(){var a=Backbone.Model.prototype.url.call(this);return a+("/"==a.charAt(a.length-1)?"":"/")},defaults:{date:!1,text:"",username:""},onSync:function(){},initialize:function(){this.urlRoot="/mix/"+this.attributes.mixId+"/comment/"}}),CommentsCollection=Backbone.Collection.extend({model:CommentModel,url:"/comments",comparator:function(a){return a.get("date")},parse:function(a){return a.comments}}),MixView=Backbone.View.extend({isPublished:!0,isSorting:!1,currentPlayingSong:!1,dblClicked:!1,dcTimeout:!1,playTimeout:!1,isUploading:!1,initialize:function(){this.listenTo(this.model,"change:title",this.onChange),this.listenTo(this.model,"change:pictureFile",this.renderPictureFile),this.listenTo(this.model,"change:isPublished",this.renderPublished),this.songs=new SongCollectionView({collection:this.model.songs,el:$(".song-list",this.el)[0]}),this.comments=new CommentCollectionView({collection:this.model.comments,el:$("#commentsList")[0]})},playSong:function(a,b){if(a){this.currentPlayingSong!=a&&this.songStopHandler(),this.currentPlayingSong=a;var c=this.songs.collection.findWhere({songOrder:this.currentPlayingSong.attributes.songOrder+1});$("#song_"+this.currentPlayingSong.id).addClass("playing"),EventDispatcher.dispatchEvent("songPlay",{song:this.currentPlayingSong,preloadSong:c,autoPlay:b})}},songStopHandler:function(){$("#song_"+this.currentPlayingSong.id).removeClass("playing"),this.currentPlayingSong=!1},songEndedHandler:function(){this.playNextSong()},playNextSong:function(){if(this.currentPlayingSong){var a=this.songs.collection.findWhere({songOrder:this.currentPlayingSong.attributes.songOrder+1});a&&this.playSong(a)}},onChange:function(){this.model.save(this.model.changed,{patch:!0})},setPublished:function(){this.isPublished||($("body").removeClass("unpublished"),$("#mixTitle").editable("destroy").off("save"),this.songs.$el.off("click",".song-delete"),$(".song-title").editable("destroy").off("save shown hidden"),$(".song-artist").editable("destroy").off("save shown hidden"),$("#removeBG").off("click"),$("#publishMixLink").off("click"),this.songs.$el.sortable("destroy"),$("#songUploader").pluploadQueue().destroy(),$("#songUploader").unbind(),$("#uploadSongForm").unbind(),$("#picUploader").pluploadQueue().destroy(),$("#picUploader").unbind(),$("#uploadPictureForm").unbind(),this.dblClicked=!1,$(window).off("beforeunload"),this.options.isPublished=this.isPublished=!0)},setUnpublished:function(){if(this.isPublished){var a=this;$("body").addClass("unpublished"),$("#mixTitle").editable({type:"text",showbuttons:!1,title:"Enter title",inputclass:"mix-title",unsavedclass:null,emptyclass:""}).on("save",function(b,c){a.model.set("title",c.newValue)}),$(".song-title").editable({type:"text",showbuttons:!1,title:"Song title",toggle:"dblclick",unsavedclass:null,emptyclass:""}).on("save",function(b,c){a.songs.editSong($(this).attr("data-id"),"title",c.newValue)}).on("shown",function(){a.dblClicked=!0,a.dcTimeout&&(clearTimeout(a.dcTimeout),a.dcTimeout=!1)}).on("hidden",function(){a.dcTimeout&&(clearTimeout(a.dcTimeout),a.dcTimeout=!1),a.dcTimeout=setTimeout(function(){a.dblClicked=!1},1e3)}),$(".song-artist").editable({type:"text",showbuttons:!1,title:"Song artist",toggle:"dblclick",unsavedclass:null,emptyclass:""}).on("save",function(b,c){a.songs.editSong($(this).attr("data-id"),"artist",c.newValue),$(this).removeClass("editable-unsaved")}).on("shown",function(){a.dblClicked=!0,a.dcTimeout&&(clearTimeout(a.dcTimeout),a.dcTimeout=!1)}).on("hidden",function(){a.dcTimeout&&(clearTimeout(a.dcTimeout),a.dcTimeout=!1),a.dcTimeout=setTimeout(function(){a.dblClicked=!1},1e3)}),this.songs.$el.on("click",".song-delete",function(){$item=$(this).parent();var b=a.songs.collection.get($item.attr("id").replace("song_",""));confirm("Are you sure you want to delete "+b.attributes.title+" by "+b.attributes.artist+"?")&&b.destroy()}),$("#removeBG").on("click",function(){a.model.set("pictureFile",""),a.model.save(a.model.changed,{patch:!0})}),$("#publishMixLink").on("click",function(){Modal.open("/static/html/modal/publish-email.html",function(){switch($(this).html()){case"Yes":a.model.set("isPublished",!0),a.model.changed.sendEmail=!0,a.model.save(a.model.changed,{patch:!0});break;case"No":a.model.set("isPublished",!0),a.model.save(a.model.changed,{patch:!0})}Modal.close()})}),this.songs.$el.sortable({start:function(){a.isSorting=!0},stop:function(){setTimeout(function(){a.isSorting=!1},0)},update:function(){a.songs.reorderSongs()}}),$("#songUploader").pluploadQueue({runtimes:"html5,flash,silverlight",url:$("#uploadSongForm").attr("action"),file_data_name:"songfile",max_file_size:"100mb",unique_names:!0,headers:{"X-CSRFToken":GLOBAL.csrfToken},rename:!0,filters:[{title:"Music files",extensions:"mp3,mp4,m4a"}],flash_swf_url:"/static/js/plupload/plupload.flash.swf",silverlight_xap_url:"/static/js/plupload/plupload.silverlight.xap",init:{Error:function(a,b){console.log("[error] ",b)},StateChanged:function(b){a.isUploading=b.state==plupload.STARTED},UploadComplete:function(){var b=$("#songUploader").pluploadQueue();b.splice(),a.isUploading=!1,$("#songUploader .plupload_buttons").css("display",""),$("#songUploader .plupload_upload_status").css("display","")},FileUploaded:function(b,c,d){var e=JSON.parse(d.response);e.success?(song=new SongModel({id:e.song_id,mixId:a.model.attributes.id,artist:e.artist,title:e.title,songOrder:e.song_order,songFile:e.song_file}),a.songs.collection.add(song),a.isPublished||($(".song-title",$("#song_"+song.id)).editable({type:"text",showbuttons:!1,title:"Song title",toggle:"dblclick",unsavedclass:null,emptyclass:""}).on("save",function(b,c){a.songs.editSong($(this).attr("data-id"),"title",c.newValue)}).on("shown",function(){a.dblClicked=!0,a.dcTimeout&&(clearTimeout(a.dcTimeout),a.dcTimeout=!1)}).on("hidden",function(){a.dcTimeout&&(clearTimeout(a.dcTimeout),a.dcTimeout=!1),a.dcTimeout=setTimeout(function(){a.dblClicked=!1},1e3)}),$(".song-artist",$("#song_"+song.id)).editable({type:"text",showbuttons:!1,title:"Song artist",toggle:"dblclick",unsavedclass:null,emptyclass:""}).on("save",function(b,c){a.songs.editSong($(this).attr("data-id"),"artist",c.newValue),$(this).removeClass("editable-unsaved")}).on("shown",function(){a.dblClicked=!0,a.dcTimeout&&(clearTimeout(a.dcTimeout),a.dcTimeout=!1)}).on("hidden",function(){a.dcTimeout&&(clearTimeout(a.dcTimeout),a.dcTimeout=!1),a.dcTimeout=setTimeout(function(){a.dblClicked=!1},1e3)}))):alert("There was an error uploading: "+e.error)}}}),$("#uploadSongForm").submit(function(){var a=$("#songUploader").pluploadQueue();return a.files.length>0?(a.bind("StateChanged",function(){a.files.length===a.total.uploaded+a.total.failed&&$("#uploadSongForm")[0].submit()}),a.start()):alert("You must queue at least one file."),!1}),$("#picUploader").pluploadQueue({runtimes:"html5,flash,silverlight",url:$("#uploadPictureForm").attr("action"),file_data_name:"picfile",max_file_size:"10mb",unique_names:!0,headers:{"X-CSRFToken":GLOBAL.csrfToken},dragdrop:!1,drop_element:"bgDropper",resize:{width:2e3,height:2e3,quality:70},rename:!0,filters:[{title:"Image files",extensions:"jpg,gif,png"}],flash_swf_url:"/static/js/plupload/plupload.flash.swf",silverlight_xap_url:"/static/js/plupload/plupload.silverlight.xap",init:{Error:function(a,b){console.log("[error] ",b)},FilesAdded:function(){$("#picUploader").pluploadQueue().start()},UploadComplete:function(){var a=$("#picUploader").pluploadQueue();a.splice(),$("#picUploader .plupload_buttons").css("display",""),$("#picUploader .plupload_upload_status").css("display","")},FileUploaded:function(b,c,d){var e=JSON.parse(d.response);e.success?a.model.set("pictureFile",e.file):alert("There was an error uploading: "+e.error)}}}),$("#picUploader_browse").html("Add"),$("#uploadPictureForm").submit(function(){var a=$("#picUploader").pluploadQueue();return a.files.length>0?(a.bind("StateChanged",function(){a.files.length===a.total.uploaded+a.total.failed&&$("#uploadPictureForm")[0].submit()}),a.start()):alert("You must queue at least one file."),!1}),$(window).on("beforeunload",function(){return a.isUploading?"You are uploading songs - are you sure you want to leave?":void 0}),this.options.isPublished=this.isPublished=!1}},renderInit:function(){if($("#mixTitle").html(this.model.attributes.title),$("#mixUsername").html("by "+this.model.attributes.username),this.renderPictureFile(),this.songs.collection.trigger("reset"),this.options.isPublished){var a=this.songs.collection.findWhere({songOrder:1});this.playSong(a,!1)}var b=this;return this.songs.$el.on("click",".song-wrapper",function(){if(!b.isSorting){var a=b.isPublished?0:500;b.playTimeout&&clearTimeout(b.playTimeout),$item=$(this).parent(),b.playTimeout=setTimeout(function(){if(!b.dblClicked){var a=b.songs.collection.get($item.attr("id").replace("song_",""));this.currentPlayingSong!=a&&b.playSong(a)}},a)}}),this.songs.$el.on("change",".favourite-checkbox",function(){$item=$(this).parent();var a=b.songs.collection.get($item.attr("id").replace("song_",""));a.set("isUserFav",this.checked),a.save(a.changed,{patch:!0})}),this.options.isUserMix&&$("#unpublishMixLink").on("click",function(){b.model.set("isPublished",!1),b.model.save(b.model.changed,{patch:!0})}),$("#btnAddComment").on("click",function(){var a=$("#txtAddComment").val().trim();if(""!=a){var c=new Date,d=new CommentModel({username:b.model.get("username"),date:c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),text:a,mixId:b.model.get("id")});d.save(),b.comments.collection.add(d),$("#txtAddComment").val("")}}),this.options.isUserMix&&($("body").addClass("admin"),this.options.isPublished||this.setUnpublished()),EventDispatcher.addEventListener("songEnded",function(){b.songEndedHandler()}),this},renderPictureFile:function(){""!=this.model.attributes.pictureFile?($("#mainWrapper").css("background-image","url("+this.model.attributes.pictureFile+")"),$("#removeBG").css("display","")):($("#mainWrapper").css("background-image",""),$("#removeBG").css("display","none"))},renderPublished:function(){this.model.attributes.isPublished?this.setPublished():this.setUnpublished()}}),SongCollectionView=Backbone.View.extend({songViews:[],initialize:function(){var a=this;this.listenTo(this.collection,"reset",this.renderReset),this.listenTo(this.collection,"changeSongOrder",this.onChangeOrder),this.listenTo(this.collection,"destroy",this.reorderSongs),this.listenTo(this.collection,"add",this.addSong),this.songViews=[],this.collection.each(function(b){a.songViews.push(new SongView({model:b,songCollectionView:a}))})},addSong:function(a){var b=new SongView({model:a,songCollectionView:this});this.songViews.push(b),this.$el.append(b.render().$el)},editSong:function(a,b,c){this.collection.each(function(d){d.attributes.id==a&&d.set(b,c)})},renderReset:function(){var a=this;return this.$el.empty(),_(this.songViews).each(function(b){a.$el.append(b.render().$el)}),this},reorderSongs:function(){var a,b,c=1,d=this;$(".song-item",this.$el).each(function(){a=$(this),a.attr("data-order")!=c&&(b=d.collection.get(a.attr("id").replace("song_","")),b.set("songOrder",c)),c++}),this.collection.trigger("changeSongOrder")},onChangeOrder:function(){this.collection.updateSongOrder()},removeView:function(a){var b=_(this.songViews).indexOf(a);this.songViews.splice(b,1)}}),SongView=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"change:title",this.onChange),this.listenTo(this.model,"change:artist",this.onChange),this.listenTo(this.model,"change:songOrder",this.renderSongOrder),this.listenTo(this.model,"change:totalFav",this.renderTotalFav),this.listenTo(this.model,"destroy",this.onDestroy),this.id="song_"+this.model.attributes.id},render:function(){var a=$("#tmpSongItem").clone();return a.attr("id",this.id).attr("data-order",this.model.songOrder),$(".song-title",a).html(this.model.attributes.title).attr("data-id",this.model.attributes.id),$(".song-artist",a).html(this.model.attributes.artist).attr("data-id",this.model.attributes.id),$(".song-order",a).html(this.model.attributes.songOrder),$(".total-favourite",a).html(this.model.attributes.totalFav+" favs"),$(".favourite-checkbox",a)[0].checked=this.model.attributes.isUserFav,this.$el=a,this},onChange:function(){this.model.save(this.model.changed,{patch:!0})},renderSongOrder:function(){$(".song-order",this.$el).html(this.model.attributes.songOrder)},renderTotalFav:function(){$(".total-favourite",this.$el).html(this.model.attributes.totalFav+" favs")},onDestroy:function(){this.remove(),this.options.songCollectionView.removeView(this)}}),CommentCollectionView=Backbone.View.extend({initialize:function(){this.listenTo(this.collection,"add",this.addComment)},addComment:function(a){var b=new CommentView({model:a});b.render(),this.$el.prepend(b.$el)}}),CommentView=Backbone.View.extend({initialize:function(){this.render()},render:function(){var a=$("#tmpCommentItem").clone();return a.attr("id",""),$(".username",a).html(this.model.attributes.username),$(".date",a).html(this.model.attributes.date),$(".text",a).html(this.model.attributes.text.replace(/\n/g,"<br>")),this.$el=a,this}}),GLOBAL={csrfToken:""},Modal={$modalWrapper:!1,open:function(a,b){this.$modalWrapper&&Modal.close();var c=this;"undefined"==typeof b&&(b=!1),this.$modalWrapper=$("#modalWrapper"),this.$modalWrapper.css("display","table"),$("td",this.$modalWrapper).html('<div class="loading">Loading ...</div>').load(a,function(){b&&c.$modalWrapper.on("click","a",b)})},close:function(){this.$modalWrapper&&($("td",this.$modalWrapper).html(""),this.$modalWrapper.css("display","").off("click"),this.$modalWrapper=!1)}},AudioPlayer={$audioPlayer1:!1,$audioPlayer2:!1,$container:!1,isReady:!1,readySong1:!1,readySong2:!1,readyPreload:!1,readyPlay:!1,init:function(){var a=this;this.$audioPlayer1=$("#jquery_jplayer_1"),this.$audioPlayer2=$("#jquery_jplayer_2"),this.$container=$("#jp_container_1"),this.$audioPlayer1.jPlayer({ready:function(){a.isReady=!0,a.readySong1&&AudioPlayer.play(a.readySong1,a.readyPreload,a.readyPlay)},ended:function(){EventDispatcher.dispatchEvent("songEnded")},pause:function(){EventDispatcher.dispatchEvent("songStop")},preload:"auto",swfPath:"/js",supplied:"mp3,m4a",cssSelectorAncestor:"#jp_container_1"}),this.$audioPlayer2.jPlayer({ready:function(){a.isReady=!0,a.readySong2&&AudioPlayer.play(a.readySong2,a.readyPreload,a.readyPlay)},ended:function(){EventDispatcher.dispatchEvent("songEnded")},pause:function(){EventDispatcher.dispatchEvent("songStop")},preload:"auto",swfPath:"/js",supplied:"mp3,m4a",cssSelectorAncestor:"#jp_container_2"}),EventDispatcher.addEventListener("songPlay",function(b){a.play(b.song,b.preloadSong,b.autoPlay)})},play:function(a,b,c){"undefined"==typeof c&&(c=!0);var d=1===a.attributes.songOrder%2;if(!this.isReady)return this.readyPlay=c,d?this.readySong1=a:this.readySong2=a,this.readyPreload=b,void 0;var e=d?this.$audioPlayer1:this.$audioPlayer2,f=a.attributes.songFile,g=f.substr(f.lastIndexOf(".")+1),h={};h[g]=f,this.$audioPlayer1.jPlayer("option","cssSelectorAncestor",""),this.$audioPlayer2.jPlayer("option","cssSelectorAncestor",""),e.jPlayer("option","cssSelectorAncestor","#jp_container_1").jPlayer("setMedia",h),c&&e.jPlayer("play"),$(".jp-title",this.$container).html(a.attributes.title);var i;b&&(i=d?this.$audioPlayer2:this.$audioPlayer1,f=b.attributes.songFile,g=f.substr(f.lastIndexOf(".")+1),h={},h[g]=f,i.jPlayer("setMedia",h)),this.readySong=!1}},Mix={view:!1,init:function(a){this.view=new MixView({model:new MixModel(a),el:$("#mix")[0],id:a.id,isUserMix:a.isUserMix,isPublished:a.isPublished,pictureFile:a.pictureFile}),AudioPlayer.init(),this.view.renderInit()}},Home={waiting:!1,init:function(){var a=this;$("#makeNewMixLink").on("click",function(){a.waiting||(a.waiting=!0,$.post($(this).attr("data-url"),{},function(b){b.success&&b.id&&(window.location="/mix/"+b.id),a.waiting=!1}),setTimeout(function(){a.waiting=!1}))}),$(".my-mixes-table").on("click",".delete-mix-link",function(){var a=$(this);confirm("Are you sure you want to delete "+$("#myMix_"+a.attr("data-id")).html()+"?")&&($.post(a.attr("data-url"),{id:a.attr("data-id")}),$("#myMixItem_"+a.attr("data-id")).remove())})}},App={init:function(a){GLOBAL.csrfToken=Cookie.get("csrftoken"),$.ajaxSetup({crossDomain:!1,beforeSend:function(a,b){csrfSafeMethod(b.type)||a.setRequestHeader("X-CSRFToken",GLOBAL.csrfToken)}}),$.fn.editable.defaults.mode="inline";var b=Backbone.sync;switch(Backbone.sync=function(a,c,d){return d.beforeSend=function(a){a.setRequestHeader("X-CSRFToken",GLOBAL.csrfToken)},b(a,c,d)},Backbone.emulateHTTP=!0,a.page){case"home":Home.init();break;case"mix":Mix.init(a)}}};